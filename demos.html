<html>
  <head>
    <title>Demos</title>
    <script src="bower_components/underscore/underscore.js"></script>
    <script src="demos.js"></script>
    <script id="vertex-shader-0" type="x-shader/x-vertex">
      precision mediump float;

      attribute vec3 position;

      varying vec3 unnormalized_ray;

      void main() {
        unnormalized_ray = position;
        gl_Position = vec4(position, 1.);
      }
    </script>
    <script id="fragment-shader-ray-direction" type="x-shader/x-fragment">
      precision mediump float;

      varying highp vec3 unnormalized_ray;

      void main() {
        vec3 ray_color = (normalize(unnormalized_ray) + vec3(1.)) / 2.;
        gl_FragColor = vec4(ray_color, 1.);
      }
    </script>
    <script id="fragment-shader-0" type="x-shader/x-fragment">
      precision mediump float;

      varying highp vec3 unnormalized_ray;

      float DistanceTo(vec3 position);
      vec4 VectorToColor(vec3 vector);

      const highp float kEpsilon = 1.e-4;
      const highp vec3 kLightDirection = vec3(1.);

      void main() {
        highp vec3 ray = normalize(unnormalized_ray);
        highp vec3 position = vec3(0.) + vec3(0., 0., 10.);

        lowp float hit = 0.;
        for (int i = 0; i < 128; ++i) {
          highp float distance = DistanceTo(position);
          position += distance * ray * (1. - (hit = float(distance < kEpsilon)));
        }

        highp vec3
            dx = vec3(kEpsilon, 0., 0.),
            dy = vec3(0., kEpsilon, 0.),
            dz = vec3(0., 0., kEpsilon);

        highp vec3 normal = normalize(vec3(
            DistanceTo(position + dx) - DistanceTo(position - dx),
            DistanceTo(position + dy) - DistanceTo(position - dy),
            DistanceTo(position + dz) - DistanceTo(position - dz)));

        highp float intensity = clamp(dot(normal, kLightDirection), 0., 1.);

        highp vec4 ray_color = VectorToColor(unnormalized_ray),
            normal_color = VectorToColor(normal);

        gl_FragColor = mix(ray_color, vec4(normal_color.rgb * intensity, 1.), hit);
      }

      float DistanceTo(vec3 position) {
        return length(position) - 1.;
      }

      vec4 VectorToColor(vec3 vector) {
        return vec4((normalize(vector) + vec3(1.)) / 2., 1.);
      }
    </script>
  </head>
  <body>
    <canvas id="c"></canvas>
  </body>
</html>
