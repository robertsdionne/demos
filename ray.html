<!-- Copyright 2010 Robert Scott Dionne. All Rights Reserved. -->
<html>
  <head>
    <script src="../closure-library/closure/goog/base.js"
        type="application/javascript"></script>
    <script src="deps.js" type="application/javascript"></script>
    <script type="application/javascript">
      goog.require('ray');
    </script>
    <script id="v" type="x-shader/x-vertex">
      attribute vec3 position;
      void main() {
        gl_Position = vec4(position, 1);
      }
    </script>
    <script id="f" type="x-shader/x-fragment">
      uniform highp vec2 resolution;
      uniform highp vec3 sphere;

      highp float distance(highp vec3 pos);
      highp vec3 rotate(highp vec3 pos, highp float a);

      highp float r = 1.32;
      highp float R = 3.44;
      void main() {
        highp vec3 pos = vec3(0.0);
        highp vec3 dir = normalize(vec3(
            (gl_FragCoord.x / resolution.x - 0.5) * 2.0,
            (gl_FragCoord.y / resolution.y - 0.5) * 2.0,
            2.0));
        bool hit = false;
        highp vec3 p;
        for (int i = 0; i < 1000; ++i) {
          p = pos-sphere;
          highp float dist = distance(p);
          if (length(pos) > 100.0) {
            break;
          }
          if (dist < max(0.001 * pos.z, 0.001)) {
            hit = true;
            break;
          }
          pos += 0.5 * dir * dist;
        }
        if (hit) {
          highp vec3 dx = vec3(0.01, 0.0,  0.0);
          highp vec3 dy = vec3(0.0,  0.01, 0.0);
          highp vec3 dz = vec3(0.0,  0.0,  0.01);
          highp vec3 pdx = p+dx;
          highp vec3 pdy = p+dy;
          highp vec3 pdz = p+dz;
          highp vec3 npdx = p-dx;
          highp vec3 npdy = p-dy;
          highp vec3 npdz = p-dz;
          highp vec3 normal = normalize(vec3(
            distance(pdx) - distance(npdx),
            distance(pdy) - distance(npdy),
            distance(pdz) - distance(npdz)));
          highp vec3 lightdir = pos - vec3(4, -4, 10);
          highp vec3 nlightdir = normalize(lightdir);
          highp vec3 lightdir2 = pos - vec3(4, 4, 10);
          highp vec3 nlightdir2 = normalize(lightdir2);
          highp float intensity = clamp(-dot(nlightdir, normal)/length(lightdir), 0.0, 1.0);
          highp float intensity2 = clamp(-dot(nlightdir2, normal)/length(lightdir2), 0.0, 1.0);
          highp float spec =
              pow(clamp(-dot(normalize(dir), reflect(nlightdir, normal)), 0.0, 1.0), 80.0);
          highp float spec2 =
              pow(clamp(-dot(normalize(dir), reflect(nlightdir2, normal)), 0.0, 1.0), 80.0);
          gl_FragColor = vec4(intensity +intensity2+ spec+spec2, intensity +intensity2+ spec+spec2, intensity +intensity2+ spec+spec2, 1.0);
        } else {
          discard;
        }
      }

      highp float distance(highp vec3 pos) {
        highp float distTop = dot(pos, vec3(0.0, 1.0, 0.0))-2.0;
        highp float distBottom = dot(pos, vec3(0.0, -1.0, 0.0))-2.0;
        highp float distCyl = length(pos.xz)-1.0;
        return max(max(distTop, distBottom), distCyl);
      }

      highp vec3 rotate(highp vec3 pos, highp float a) {
        highp mat3 r = mat3(1);
        r[0][0] = cos(a);
        r[2][0] = sin(a);
        r[0][2] = -sin(a);
        r[2][2] = cos(a);
        return r * pos;
      }
    </script>
  </head>
  <body onload="ray.load();">
    <canvas id="c"></canvas>
    <div id="fps"></div>
  </body>
</html>
